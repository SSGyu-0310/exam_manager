#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$ROOT_DIR"

if [[ ! -f ".env" && ! -f ".env.docker" ]]; then
  echo "[dev-backend] env file not found." >&2
  echo "[dev-backend] create one first: cp .env.example .env" >&2
  echo "[dev-backend] or: cp .env.docker.example .env.docker" >&2
  exit 1
fi

if [[ -x "$ROOT_DIR/.venv/bin/python" ]]; then
  PYTHON_BIN="$ROOT_DIR/.venv/bin/python"
elif command -v python >/dev/null 2>&1; then
  PYTHON_BIN="$(command -v python)"
else
  echo "[dev-backend] python interpreter not found." >&2
  exit 1
fi

load_env_file() {
  local file="$1"
  if [[ -f "$file" ]]; then
    set -a
    # shellcheck disable=SC1090
    source "$file"
    set +a
  fi
}

# Load docker defaults first, then let local .env override for host dev.
load_env_file ".env.docker"
load_env_file ".env"

export FLASK_CONFIG="${FLASK_CONFIG:-development}"
export FLASK_DEBUG="${FLASK_DEBUG:-1}"
export PORT="${PORT:-5000}"
db_user="${POSTGRES_USER:-exam}"
db_password="${POSTGRES_PASSWORD:-exam_dev_password}"
db_name="${POSTGRES_DB:-exam_manager}"
export DATABASE_URL="${DATABASE_URL:-postgresql+psycopg://${db_user}:${db_password}@127.0.0.1:5432/${db_name}}"
export SEARCH_BACKEND="${SEARCH_BACKEND:-postgres}"
export CORS_ALLOWED_ORIGINS="${CORS_ALLOWED_ORIGINS:-http://localhost:4000}"

if [[ "${DEV_BACKEND_AUTO_START_DB:-1}" == "1" ]]; then
  echo "[dev-backend] ensuring db container is up"
  "$ROOT_DIR/scripts/dev-db" up -d db >/dev/null
  echo "[dev-backend] waiting for db readiness"
  ready=0
  for _ in $(seq 1 30); do
    if "$ROOT_DIR/scripts/dev-db" exec -T db sh -lc 'pg_isready -U "$POSTGRES_USER" -d "$POSTGRES_DB" >/dev/null 2>&1'; then
      ready=1
      break
    fi
    sleep 1
  done
  if [[ "$ready" -ne 1 ]]; then
    echo "[dev-backend] db is not ready. Check: ./scripts/dev-db logs -f db" >&2
    exit 1
  fi
fi

exec "$PYTHON_BIN" run.py
